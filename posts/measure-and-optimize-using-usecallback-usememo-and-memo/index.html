<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.24.40"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><title data-react-helmet="true">「测试并优化」useCallback, useMemo 与 React.memo | 浅色圆锥曲线爱好者</title><link data-react-helmet="true" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@4/distr/fira_code.css"/><link data-react-helmet="true" rel="canonical" href="https://blog.rainy.me/posts/measure-and-optimize-using-usecallback-usememo-and-memo"/><meta data-react-helmet="true" name="description" content="blog of yue: 有人一直问我有关 React.memo,useCallback 和 useMemo 正确使用的问题，正好上周有做相关的工作就在这里总结一下。 测试代码(不包含 style)： tsx import React, { memo, useMemo, useState, useCallback } from &quot;react&quot;..."/><meta data-react-helmet="true" property="og:title" content="「测试并优化」useCallback, useMemo 与 React.memo"/><meta data-react-helmet="true" property="og:description" content="blog of yue: 有人一直问我有关 React.memo,useCallback 和 useMemo 正确使用的问题，正好上周有做相关的工作就在这里总结一下。 测试代码(不包含 style)： tsx import React, { memo, useMemo, useState, useCallback } from &quot;react&quot;..."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="yue"/><meta data-react-helmet="true" name="twitter:title" content="「测试并优化」useCallback, useMemo 与 React.memo"/><meta data-react-helmet="true" name="twitter:description" content="blog of yue: 有人一直问我有关 React.memo,useCallback 和 useMemo 正确使用的问题，正好上周有做相关的工作就在这里总结一下。 测试代码(不包含 style)： tsx import React, { memo, useMemo, useState, useCallback } from &quot;react&quot;..."/><style data-styled="" data-styled-version="5.2.1">.fmgzrg{padding:3px 10px;font-size:1rem;cursor:pointer;background-color:hotpink;border:0;border-radius:5px;}/*!sc*/
.fmgzrg:hover{background-color:pink;}/*!sc*/
.cbKaxN{padding:3px 10px;font-size:1rem;cursor:pointer;background-color:skyblue;border:0;border-radius:5px;}/*!sc*/
.cbKaxN:hover{background-color:cyan;}/*!sc*/
data-styled.g8[id="useCallbackUseMemoDemo__Button-ce7s59-0"]{content:"fmgzrg,cbKaxN,"}/*!sc*/
.kdTZZd{margin:20px 0;}/*!sc*/
.kdTZZd > *{margin:0 10px;}/*!sc*/
data-styled.g9[id="useCallbackUseMemoDemo__ChildBlock-ce7s59-1"]{content:"kdTZZd,"}/*!sc*/
.fUidtz{padding:1rem;font-size:1.2rem;text-align:center;}/*!sc*/
data-styled.g10[id="useCallbackUseMemoDemo__DemoBlock-ce7s59-2"]{content:"fUidtz,"}/*!sc*/
.NfRVw{font-size:1rem;background-color:#333;box-shadow:0 1px 3px #000;color:#fff;padding:0.5rem;}/*!sc*/
data-styled.g14[id="footer__GlobalFooter-sc-6bj9pp-0"]{content:"NfRVw,"}/*!sc*/
.jWShHr{background:#333;box-shadow:0 0 3px #000;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:baseline;-webkit-box-align:baseline;-ms-flex-align:baseline;align-items:baseline;color:#ccc;text-align:left;font-size:1rem;padding:0.5rem;}/*!sc*/
data-styled.g15[id="header__GlobalHeader-sc-1d76vqs-0"]{content:"jWShHr,"}/*!sc*/
.hSDgvG > a{margin:0 10px;}/*!sc*/
@media screen and (max-width:700px){.hSDgvG{display:none;}}/*!sc*/
data-styled.g17[id="header__RightCorner-sc-1d76vqs-2"]{content:"hSDgvG,"}/*!sc*/
@font-face{font-family:'great-vibes-merge';unicode-range:U+0021-007A;src:url('/fonts/GreatVibes-Regular.woff2') format('woff2');}/*!sc*/
@font-face{font-family:'noto-serif-sc';src:url('/fonts/NotoSerifSC-Regular.subset.woff2') format('woff2');unicode-range:U+3000-9FFF;}/*!sc*/
*{box-sizing:border-box;-ms-overflow-style:none;-webkit-scrollbar-width:none;-moz-scrollbar-width:none;-ms-scrollbar-width:none;scrollbar-width:none;}/*!sc*/
*::selection{color:#fff;background:skyblue;}/*!sc*/
::-webkit-scrollbar{display:none;width:0px;background:transparent;}/*!sc*/
html,body{font-family:sans-serif;text-align:center;font-size:20px;color:#ffffff;margin:0;padding:0;width:100%;height:100%;background-color:#1d1d1d;}/*!sc*/
ul{margin:0;padding:0;list-style:none;}/*!sc*/
a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
#___gatsby{width:100%;min-height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}/*!sc*/
#___gatsby > div{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;min-height:100%;}/*!sc*/
main{padding-bottom:3rem;}/*!sc*/
data-styled.g19[id="sc-global-cEbgiz1"]{content:"sc-global-cEbgiz1,"}/*!sc*/
.ctnZPS pre{background-color:#333;padding:1rem;font-size:0.9rem;overflow:scroll;text-align:left;border:0;box-shadow:0 0 10px #111;border-radius:10px;}/*!sc*/
.ctnZPS pre code{font-family:"Fira Code";background:none;text-shadow:none;}/*!sc*/
.ctnZPS pre code .keyword{color:hotpink;}/*!sc*/
.ctnZPS pre code .punctuation{color:skyblue;}/*!sc*/
.ctnZPS pre code .tag{color:hotpink;}/*!sc*/
.ctnZPS pre code .builtin{color:mediumpurple;}/*!sc*/
.ctnZPS pre code .operator{color:hotpink;}/*!sc*/
.ctnZPS pre code .function{color:#ffd54f;}/*!sc*/
.ctnZPS pre code .constant{color:mediumpurple;}/*!sc*/
.ctnZPS pre code .parameter{color:#fb8c00;}/*!sc*/
.ctnZPS pre code .string{color:yellowgreen;}/*!sc*/
.ctnZPS pre code .comment{color:#555;}/*!sc*/
.ctnZPS pre code .class-name{color:skyblue;}/*!sc*/
data-styled.g20[id="codeBlock-sc-12lvfgr-0"]{content:"ctnZPS,"}/*!sc*/
.iGRAlZ{margin:0 auto;width:80%;padding-bottom:8rem;}/*!sc*/
@media screen and (max-width:700px){.iGRAlZ{width:90%;}}/*!sc*/
data-styled.g21[id="comments__CommentBlock-sc-9weum8-0"]{content:"iGRAlZ,"}/*!sc*/
.issIJo{margin:0 auto;padding-bottom:1rem;text-align:left;max-width:1000px;word-break:break-all;width:90%;color:#ccc;font-family:"Fira Code";}/*!sc*/
.issIJo > *{max-width:100%;}/*!sc*/
.issIJo h2,.issIJo h3,.issIJo h4,.issIJo h5,.issIJo h6{margin-top:3rem;color:#eee;position:relative;}/*!sc*/
.issIJo h2::before,.issIJo h3::before,.issIJo h4::before,.issIJo h5::before,.issIJo h6::before{content:"○";position:absolute;color:#607d8b;top:0;left:-1.5rem;}/*!sc*/
.issIJo h2::before{content:"#";}/*!sc*/
.issIJo h3::before{content:"◆";}/*!sc*/
.issIJo del{color:#555;}/*!sc*/
.issIJo img{-webkit-transition:0.3s all ease-in-out;transition:0.3s all ease-in-out;display:block;margin:2rem auto;max-width:100%;object-fit:contain;opacity:0.8;}/*!sc*/
.issIJo img:hover{opacity:1;}/*!sc*/
.issIJo a{position:relative;z-index:1;}/*!sc*/
.issIJo a::after{-webkit-transition:0.3s all ease-in-out;transition:0.3s all ease-in-out;content:" ";position:absolute;width:100%;height:2px;background-color:#607d8b;left:0;bottom:0;z-index:-1;}/*!sc*/
.issIJo a:hover{color:#fff;text-shadow:0 0 3px #000;}/*!sc*/
.issIJo a:hover::after{background-color:hotpink;}/*!sc*/
.issIJo ul{list-style:disc;padding-left:1rem;}/*!sc*/
.issIJo table{margin:3rem auto;border-collapse:collapse;}/*!sc*/
.issIJo table th,.issIJo table tr,.issIJo table td{padding:10px;border:3px solid #333;}/*!sc*/
.issIJo blockquote{padding:1rem;margin:1rem 0;background-color:#333;}/*!sc*/
.issIJo code{text-shadow:0 0 5px #000;word-break:break-word;border-radius:5px;margin:5px 2px;display:inline-block;padding:1px 5px;font-family:"Fira Code";background-image:linear-gradient(100deg,#455a64 47%,#757575);}/*!sc*/
.issIJo iframe{width:80%;margin:0 auto;display:inherit;}/*!sc*/
@media screen and (max-width:700px){.issIJo h2::before,.issIJo h3::before,.issIJo h4::before,.issIJo h5::before,.issIJo h6::before{top:0.2rem;font-size:1rem;left:-1rem;}.issIJo iframe{max-width:100%;width:100%;}}/*!sc*/
data-styled.g22[id="markdownContent__MarkdownContentBlock-sc-1c6mo1j-0"]{content:"issIJo,"}/*!sc*/
.gGdKwU{font-size:inherit;padding:1rem;font-family:'great-vibes-merge','noto-serif-sc';-webkit-filter:drop-shadow(0 0 3px #000);filter:drop-shadow(0 0 3px #000);width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;display:inline-block;font-weight:normal;text-align:center;background:linear-gradient(180deg,skyblue,#e91e63);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}/*!sc*/
@media screen and (max-width:700px){.gGdKwU{font-size:4rem;}}/*!sc*/
data-styled.g23[id="gradientFont-sc-6873be-0"]{content:"gGdKwU,"}/*!sc*/
.cyZxmM{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin:4rem;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:baseline;-webkit-box-align:baseline;-ms-flex-align:baseline;align-items:baseline;}/*!sc*/
.cyZxmM a{margin:1rem;}/*!sc*/
@media screen and (max-width:700px){.cyZxmM{margin:0;margin-bottom:3rem;}.cyZxmM a{margin:1rem 5px;}}/*!sc*/
data-styled.g53[id="pagination__PaginationNav-sc-1nud1ku-0"]{content:"cyZxmM,"}/*!sc*/
.iENrYe{-webkit-transition:0.5s all cubic-bezier(0.4,0,0.2,1);transition:0.5s all cubic-bezier(0.4,0,0.2,1);box-shadow:#0 0 5px #000;background:#333;color:none;border-radius:5px;padding:0.5rem;background-size:200%,150%;}/*!sc*/
.iENrYe:hover{background-color:#e91e63;}/*!sc*/
data-styled.g54[id="pagination__PaginationLink-sc-1nud1ku-1"]{content:"iENrYe,"}/*!sc*/
.kUfmsL{font-size:4rem;word-break:break-word;margin-bottom:1rem;}/*!sc*/
@media screen and (max-width:700px){.kUfmsL{font-size:4rem;}}/*!sc*/
data-styled.g58[id="post__PostTitle-sc-1xlzpqm-0"]{content:"kUfmsL,"}/*!sc*/
.entpDK{font-size:1.5rem;color:#666;margin-bottom:2rem;display:inline-block;text-shadow:0 0 1rem #000;}/*!sc*/
data-styled.g59[id="post__PostDate-sc-1xlzpqm-1"]{content:"entpDK,"}/*!sc*/
</style><link rel="icon" href="/favicon-32x32.png?v=9cddaf2e6e675db0946c978328f41acf" type="image/png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#333333"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9cddaf2e6e675db0946c978328f41acf"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9cddaf2e6e675db0946c978328f41acf"/><link as="script" rel="preload" href="/webpack-runtime-a381b291fba9b8d72f96.js"/><link as="script" rel="preload" href="/framework-d018bf9a55d82f10618c.js"/><link as="script" rel="preload" href="/app-8674ff2d423d1c45de71.js"/><link as="script" rel="preload" href="/2c282eaea363d2bbd23f6fd873d3621ed8cccc49-00a73d1bcd5f8ea4550f.js"/><link as="script" rel="preload" href="/2595aca8b7d3d21cc09d2fd82059f82ae42ef8db-7d5256a5ccad346d8436.js"/><link as="script" rel="preload" href="/component---src-templates-post-index-tsx-d31780e81820518cdb6d.js"/><link as="fetch" rel="preload" href="/page-data/posts/measure-and-optimize-using-usecallback-usememo-and-memo/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1132682437.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/764694655.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><header class="header__GlobalHeader-sc-1d76vqs-0 jWShHr"><span class="header__LeftCorner-sc-1d76vqs-1 hlA-dLO"><a href="/">浅色圆锥曲线爱好者</a></span><span class="header__RightCorner-sc-1d76vqs-2 hSDgvG"><a href="/posts">Posts</a><a href="/notes">Notes</a><a href="/aboutme">About</a></span></header><main style="opacity:0"><div><h1 class="post__PostTitle-sc-1xlzpqm-0 kUfmsL"><span class="gradientFont-sc-6873be-0 gGdKwU">「测试并优化」useCallback, useMemo 与 React.memo</span></h1><time class="post__PostDate-sc-1xlzpqm-1 entpDK">2020-04-02</time><article class="codeBlock-sc-12lvfgr-0 markdownContent__MarkdownContentBlock-sc-1c6mo1j-0 ctnZPS issIJo"><p>有人一直问我有关 <code class="language-text">React.memo</code>,<code class="language-text">useCallback</code> 和 <code class="language-text">useMemo</code> 正确使用的问题，正好上周有做相关的工作就在这里总结一下。</p><h2>测试代码(不包含 style)：</h2><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> memo<span class="token punctuation">,</span> useMemo<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> useCallback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Child</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  index<span class="token punctuation">,</span>
  decrease<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  index<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token function-variable function">decrease</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> rerender</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">child:</span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">parent -</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setState</span><span class="token punctuation">(</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">child +</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> MemoizedChild <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span>Child<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">increase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">decrease</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> decreaseCallback <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">decrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> UseMemoChild1 <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    decrease<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> UseMemoChild2 <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>decreaseCallback<span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Count </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>increase<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">parent +</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MemoizedChild</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MemoizedChild</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>UseMemoChild1<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span>UseMemoChild2<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h2>渲染结果：</h2><div class="useCallbackUseMemoDemo__DemoBlock-ce7s59-2 fUidtz"><p class="useCallbackUseMemoDemo__Title-ce7s59-3 iWWngM">Parent: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent +</button><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->1<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->2<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->3<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->4<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->5<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div><div class="useCallbackUseMemoDemo__ChildBlock-ce7s59-1 kdTZZd"><p>Child-<!-- -->6<!-- -->: <!-- -->0</p><button color="hotpink" class="useCallbackUseMemoDemo__Button-ce7s59-0 fmgzrg">parent -</button><button color="skyblue" class="useCallbackUseMemoDemo__Button-ce7s59-0 cbKaxN">child +</button></div></div><p>这边有六个子组件的例子，分别使用不同的渲染逻辑</p><ul><li>Child-1 传入普通的 <code class="language-text">decrease</code> 函数</li><li>Child-2 传入使用<code class="language-text">useCallback</code>的<code class="language-text">decrease</code>函数</li><li>Child-3 使用 <code class="language-text">memo</code>，传入普通的 <code class="language-text">decrease</code> 函数</li><li>Child-4 使用 <code class="language-text">memo</code>，传入使用<code class="language-text">useCallback</code>的<code class="language-text">decrease</code>函数</li><li>Child-5 使用 <code class="language-text">useMemo</code>，用普通的 <code class="language-text">decrease</code> 函数作为<code class="language-text">dependency array</code></li><li>Child-6 使用 <code class="language-text">useMemo</code>，用使用<code class="language-text">useCallback</code>的<code class="language-text">decrease</code>函数作为<code class="language-text">dependency array</code></li></ul><p>当按下 <code class="language-text">child +</code> 的时候对应的子组件再渲染一次。没有什么好奇怪的。</p><p>但是当我们按下<code class="language-text">parent -</code> 或者 <code class="language-text">parent +</code>，只有 Child-1, Child-2, Child-3, Child-5 被再次渲染。这是为什么的呢？</p><p>其实看 react 的开发工具就很明显</p><p>事前准备:</p><ul><li>在<code class="language-text">Profiler</code>里选上记录每次渲染的理由</li></ul><p><img src="https://cloud.rainy.me/blog/c4d01a.png"/></p><ul><li>在通常里同样可以选上高亮渲染中的组件，哪个组件发生了再渲染一目了然。</li></ul><p><img src="https://cloud.rainy.me/blog/db1c74.png"/></p><p>通过 profiling 记录点击事件。然后可以的到这样的<code class="language-text">Framegraph</code></p><p><img src="https://cloud.rainy.me/blog/35d43d.png"/></p><p>hover 到第一个 Child 组件上，可以看到产生再渲染的理由是 <code class="language-text">decrease</code>这个<code class="language-text">props</code>发生了改变。由于 js 的特性，当父组件发生在渲染的时候，<code class="language-text">decrease</code>这个函数也会被重新声明，导致和之前的函数 reference 不同，所以产生了 props 的不同，导致再渲染</p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p><img src="https://cloud.rainy.me/blog/29b221.png"/></p><p>hover 到第二个 Child 组件上，可以看到在渲染的理由是<code class="language-text">The parent component rendered</code>也就是由于父组件发生再渲染，这个子组件也产生了再渲染。因为使用了<code class="language-text">useCallback</code>，所以 props 并没有发生改变。</p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p><img src="https://cloud.rainy.me/blog/9943f7.png"/></p><p>hover 到第三个 Child 组件上，可以看见再渲染的理由和第一个一样。这边虽然使用了<code class="language-text">memo</code>但是由于 props 的改变，<code class="language-text">memo</code>并没有产生期待的效果。</p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MemoizedChild</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p><img src="https://cloud.rainy.me/blog/0e0ec1.png"/></p><p>第四个组件，开发工具显示并没有在这个周期内发生再渲染。由于 props 并没有发生改变，用是使用了<code class="language-text">memo</code>，即使父组件发生再渲染，子组件不会产生不不必要的渲染。这个原来的<code class="language-text">Pure Component</code>是类似的。</p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MemoizedChild</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p><img src="https://cloud.rainy.me/blog/5d11e3.png"/></p><p>第五个子组件，发生再渲染的理由和第一个一样，虽然这里使用了<code class="language-text">useMemo</code>，但是由于<code class="language-text">decrease</code>函数的改变同样发生了更新。如果看页面的 console，可以看到这样的警告：</p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> UseMemoChild1 <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decrease<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  decrease<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>UseMemoChild1<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div><div class="gatsby-highlight" data-language="log"><pre style="counter-reset:linenumber NaN" class="language-log line-numbers"><code class="language-log">Line 26:9:  The &#x27;decrease&#x27; function makes the dependencies ofuseMemo Hook (at line 29) change on every render.
To fix this, wrap the &#x27;decrease&#x27; definition into its own useCallback() Hook  react-hooks/exhaustive-deps</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span></span></pre></div><p><img src="https://cloud.rainy.me/blog/1b9309.png"/></p><div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset:linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> UseMemoChild2 <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">index</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span></span> <span class="token attr-name">decrease</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>decreaseCallback<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>decreaseCallback<span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>UseMemoChild2<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>第六个组件和第四个一样没有发生再渲染。</p><p>那么什么时候使用<code class="language-text">memo</code>，什么时候使用<code class="language-text">useMemo</code>呢？ 个人认为要基于子组件的具体使用情况选择。<code class="language-text">useMemo</code>的好处是可以在父组件中很清晰的看到什么时候子组件会发生再渲染。但是只能在父组件内部有效。如果一个组件在许多地方都有使用，并且基本渲染方式只取决于 props 的话<code class="language-text">export</code>一个<code class="language-text">memo</code>化的组件更加合适。</p><h2>appendix</h2><p>最近读了一篇有关 redux 的性能优化文章觉得非常有道理。十分推荐阅读。 &gt;&gt; <a href="https://medium.com/javascript-in-plain-english/https-medium-com-javascript-in-plain-english-why-you-should-use-an-object-not-an-array-for-lists-bee4a1fbc8bd">Why you should use an object, and not an array, for lists in Redux</a></p><p>在进行 list 的 <code class="language-text">CRUD</code> 操作时，<code class="language-text">object</code> 比 <code class="language-text">list</code> 不仅性能好实际的 <code class="language-text">reducer</code> 也写起来方便的多。可以说是非常魔法的优化技巧了。</p></article></div><nav class="pagination__PaginationNav-sc-1nud1ku-0 cyZxmM"><a href="/posts/arch-linux-with-desktop-pc"><span class="pagination__PaginationLink-sc-1nud1ku-1 iENrYe">&lt; Arch Linux &amp; Desktop PC Setup</span></a><a href="/posts/about-webpack-externals"><span class="pagination__PaginationLink-sc-1nud1ku-1 iENrYe">About webpack externals &gt;</span></a></nav><div class="comments__CommentBlock-sc-9weum8-0 iGRAlZ"><div shortname="yue-blog" config="[object Object]" id="disqus_thread"></div></div></main></div><footer class="footer__GlobalFooter-sc-6bj9pp-0 NfRVw">© <!-- -->2020</footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/measure-and-optimize-using-usecallback-usememo-and-memo";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-2b9c2143bc2048f0e806.js"],"app":["/app-8674ff2d423d1c45de71.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-3366c0891f0c3afc2f72.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-a5ad74968dbce0588591.js"],"component---src-pages-aboutme-tsx":["/component---src-pages-aboutme-tsx-83d8daf3dab84b586c14.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-b9d3c82973606f4d0eb7.js"],"component---src-pages-ogp-tsx":["/component---src-pages-ogp-tsx-13617ce9f806ce325ad7.js"],"component---src-templates-note-archive-tsx":["/component---src-templates-note-archive-tsx-edcf0e20c4902314ab66.js"],"component---src-templates-note-index-tsx":["/component---src-templates-note-index-tsx-f0d84ed1557a5d10746c.js"],"component---src-templates-post-archive-tsx":["/component---src-templates-post-archive-tsx-1e13a47d11a27bcb52fb.js"],"component---src-templates-post-index-tsx":["/component---src-templates-post-index-tsx-d31780e81820518cdb6d.js"]};/*]]>*/</script><script src="/polyfill-2b9c2143bc2048f0e806.js" nomodule=""></script><script src="/component---src-templates-post-index-tsx-d31780e81820518cdb6d.js" async=""></script><script src="/2595aca8b7d3d21cc09d2fd82059f82ae42ef8db-7d5256a5ccad346d8436.js" async=""></script><script src="/2c282eaea363d2bbd23f6fd873d3621ed8cccc49-00a73d1bcd5f8ea4550f.js" async=""></script><script src="/app-8674ff2d423d1c45de71.js" async=""></script><script src="/framework-d018bf9a55d82f10618c.js" async=""></script><script src="/webpack-runtime-a381b291fba9b8d72f96.js" async=""></script></body></html>